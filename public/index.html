<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skipped Tests Trend — wix-data-client</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    /* ── Header ─────────────────────────────────────────── */
    .header {
      background: #fff;
      border-bottom: 1px solid #e2e6ea;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      width: 40px;
      height: 40px;
      background: #eef0ff;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .header-logo svg {
      width: 22px;
      height: 22px;
      color: #5b6abf;
    }

    .header-text h1 {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
      line-height: 1.2;
    }

    .header-text p {
      font-size: 13px;
      color: #8a8fa8;
      line-height: 1.3;
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right svg {
      width: 18px;
      height: 18px;
      color: #5b6abf;
    }

    select {
      background: #fff;
      border: 1px solid #d5d9e0;
      color: #3a3f58;
      padding: 8px 32px 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238a8fa8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #5b6abf;
      box-shadow: 0 0 0 3px rgba(91, 106, 191, 0.15);
    }

    .btn-refresh {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #fff;
      border: 1px solid #d5d9e0;
      color: #3a3f58;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-refresh:hover {
      background: #f5f6fa;
      border-color: #5b6abf;
    }

    .btn-refresh svg {
      width: 16px;
      height: 16px;
      color: #5b6abf;
    }

    /* ── Container ──────────────────────────────────────── */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ── Main grid: chart + summary side by side ────────── */
    .main-row {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      margin-bottom: 24px;
      align-items: start;
    }

    @media (max-width: 860px) {
      .main-row {
        grid-template-columns: 1fr;
      }
    }

    /* ── Chart card ─────────────────────────────────────── */
    .chart-card {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 14px;
      padding: 24px;
    }

    .chart-card h2 {
      font-size: 16px;
      font-weight: 700;
      color: #1a1a2e;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 340px;
    }

    /* ── Summary card ───────────────────────────────────── */
    .summary-card {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 14px;
      padding: 28px 24px;
    }

    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #5b6abf;
    }

    .summary-dash {
      font-size: 18px;
      color: #c8ccd4;
    }

    .summary-value {
      font-size: 48px;
      font-weight: 800;
      color: #1a1a2e;
      line-height: 1.1;
      margin-bottom: 20px;
    }

    .summary-divider {
      border: none;
      border-top: 1px solid #e8ebf0;
      margin-bottom: 18px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
    }

    .summary-row-label {
      font-size: 14px;
      color: #8a8fa8;
    }

    .summary-row-value {
      font-size: 15px;
      font-weight: 600;
      color: #1a1a2e;
    }

    .trend-up { color: #e5484d !important; }
    .trend-down { color: #2da44e !important; }
    .trend-flat { color: #8a8fa8 !important; }

    /* ── Webhook section ────────────────────────────────── */
    .webhook-section {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 14px;
      padding: 24px;
    }

    .webhook-section h2 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 14px;
      color: #1a1a2e;
    }

    .webhook-url {
      background: #f5f6fa;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 14px;
      color: #5b6abf;
      word-break: break-all;
      margin-bottom: 16px;
    }

    .webhook-url .method {
      color: #2da44e;
      font-weight: 700;
    }

    pre {
      background: #f5f6fa;
      border: 1px solid #e2e6ea;
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
      color: #3a3f58;
    }

    .schema-note {
      font-size: 13px;
      color: #8a8fa8;
      margin-bottom: 8px;
    }

    .gh-action-label {
      font-size: 14px;
      font-weight: 600;
      color: #3a3f58;
      margin: 20px 0 8px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8a8fa8;
    }

    .empty-state p {
      margin-top: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 3h6v7l4 9H5l4-9V3z"/>
        <line x1="9" y1="3" x2="15" y2="3"/>
      </svg>
    </div>
    <div class="header-text">
      <h1>Skipped Tests Trend</h1>
      <p>wix-data-client repository</p>
    </div>
    <div class="header-right">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
      <select id="branch-select">
        <option value="">All branches</option>
      </select>
      <button class="btn-refresh" id="btn-refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
          <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
        </svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Chart + Summary side by side -->
    <div class="main-row">
      <div class="chart-card">
        <h2>Skipped Tests Over Time</h2>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
        <div class="empty-state" id="empty-state" style="display:none;">
          <p>No data yet. Send a POST to the webhook below to start tracking.</p>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-header">
          <span class="summary-label">Today's Skipped</span>
          <span class="summary-dash">—</span>
        </div>
        <div class="summary-value" id="today-skipped">—</div>
        <hr class="summary-divider">
        <div class="summary-row">
          <span class="summary-row-label">7-day average</span>
          <span class="summary-row-value" id="avg-7d">—</span>
        </div>
        <div class="summary-row">
          <span class="summary-row-label">Trend</span>
          <span class="summary-row-value" id="trend-label">—</span>
        </div>
      </div>
    </div>

    <!-- Webhook docs -->
    <div class="webhook-section">
      <h2>Webhook Endpoint</h2>
      <div class="webhook-url">
        <span class="method">POST</span> <span id="webhook-url"></span>
      </div>

      <p class="schema-note">Expected JSON body:</p>
      <pre>{
  "date":          "2025-06-15",       // YYYY-MM-DD (required)
  "repo":          "wix-data-client",  // optional, defaults to wix-data-client
  "branch":        "master",           // required
  "total_tests":   4500,               // non-negative integer (required)
  "skipped_count": 42                  // non-negative integer (required)
}</pre>

      <p class="gh-action-label">Example GitHub Actions step:</p>
      <pre>- name: Report skipped tests
  run: |
    curl -X POST $DASHBOARD_URL/api/webhook \
      -H "Content-Type: application/json" \
      -d '{
        "date": "'$(date +%Y-%m-%d)'",
        "repo": "wix-data-client",
        "branch": "${{ github.ref_name }}",
        "total_tests": '$TOTAL_TESTS',
        "skipped_count": '$SKIPPED_COUNT'
      }'</pre>

      <p class="gh-action-label">Example cURL:</p>
      <pre>curl -X POST http://localhost:3000/api/webhook \
  -H "Content-Type: application/json" \
  -d '{"date":"2025-06-15","branch":"master","total_tests":4500,"skipped_count":42}'</pre>
    </div>
  </div>

  <script>
    const API = '';
    let chart = null;

    const branchSelect = document.getElementById('branch-select');
    const webhookUrlEl = document.getElementById('webhook-url');
    const btnRefresh = document.getElementById('btn-refresh');

    webhookUrlEl.textContent = `${window.location.origin}/api/webhook`;

    async function fetchJSON(url) {
      const res = await fetch(url);
      return res.json();
    }

    async function loadBranches() {
      const branches = await fetchJSON(`${API}/api/branches`);
      branchSelect.innerHTML = '<option value="">All branches</option>';
      branches.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        branchSelect.appendChild(opt);
      });
    }

    async function loadSummary(branch) {
      const params = branch ? `?branch=${encodeURIComponent(branch)}` : '';
      const data = await fetchJSON(`${API}/api/summary${params}`);

      document.getElementById('today-skipped').textContent =
        data.today_skipped !== null ? data.today_skipped : '—';

      document.getElementById('avg-7d').textContent =
        data.avg_7d !== null ? data.avg_7d : '—';

      const trendEl = document.getElementById('trend-label');
      const labels = { up: 'Up', down: 'Down', flat: 'Flat' };
      trendEl.textContent = labels[data.trend] || '—';
      trendEl.className = `summary-row-value trend-${data.trend}`;
    }

    async function loadChart(branch) {
      const params = branch ? `?branch=${encodeURIComponent(branch)}` : '';
      const rows = await fetchJSON(`${API}/api/timeseries${params}`);

      const emptyState = document.getElementById('empty-state');
      const canvas = document.getElementById('chart');

      if (!rows.length) {
        emptyState.style.display = 'block';
        canvas.style.display = 'none';
        if (chart) { chart.destroy(); chart = null; }
        return;
      }

      emptyState.style.display = 'none';
      canvas.style.display = 'block';

      const labels = rows.map(r => {
        const d = new Date(r.date + 'T00:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const skipped = rows.map(r => r.skipped_count);

      if (chart) chart.destroy();

      chart = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Skipped Tests',
              data: skipped,
              borderColor: '#5b6abf',
              backgroundColor: 'rgba(91, 106, 191, 0.08)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointBackgroundColor: '#5b6abf',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              pointHoverRadius: 7,
              borderWidth: 2.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#fff',
              titleColor: '#1a1a2e',
              bodyColor: '#3a3f58',
              borderColor: '#e2e6ea',
              borderWidth: 1,
              padding: 10,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: (items) => items[0].label,
                label: (item) => `Skipped: ${item.raw}`,
              },
            },
          },
          scales: {
            x: {
              ticks: { color: '#8a8fa8', font: { size: 12 } },
              grid: { display: false },
              border: { display: false },
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#8a8fa8', font: { size: 12 }, stepSize: 15 },
              grid: { color: '#eef0f4', drawTicks: false },
              border: { display: false, dash: [4, 4] },
            },
          },
        },
      });
    }

    async function refresh() {
      const branch = branchSelect.value;
      await Promise.all([loadSummary(branch), loadChart(branch)]);
    }

    branchSelect.addEventListener('change', refresh);
    btnRefresh.addEventListener('click', refresh);

    loadBranches().then(refresh);
  </script>
</body>
</html>
