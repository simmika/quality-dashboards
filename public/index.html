<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skipped Tests Trend — wix-data-client</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
    }

    /* ── Header ─────────────────────────────────────────── */
    .header {
      background: #fff;
      border-bottom: 1px solid #e2e6ea;
      padding: 16px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      width: 40px;
      height: 40px;
      background: #eef0ff;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .header-logo svg {
      width: 22px;
      height: 22px;
      color: #5b6abf;
    }

    .header-text h1 {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
      line-height: 1.2;
    }

    .header-text p {
      font-size: 13px;
      color: #8a8fa8;
      line-height: 1.3;
    }

    .header-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right > svg {
      width: 18px;
      height: 18px;
      color: #5b6abf;
    }

    select {
      background: #fff;
      border: 1px solid #d5d9e0;
      color: #3a3f58;
      padding: 8px 32px 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%238a8fa8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      cursor: pointer;
    }

    select:focus {
      outline: none;
      border-color: #5b6abf;
      box-shadow: 0 0 0 3px rgba(91, 106, 191, 0.15);
    }

    .btn-refresh {
      display: flex;
      align-items: center;
      gap: 6px;
      background: #fff;
      border: 1px solid #d5d9e0;
      color: #3a3f58;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
    }

    .btn-refresh:hover {
      background: #f5f6fa;
      border-color: #5b6abf;
    }

    .btn-refresh svg {
      width: 16px;
      height: 16px;
      color: #5b6abf;
    }

    /* ── Container ──────────────────────────────────────── */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* ── Main grid: chart + summary side by side ────────── */
    .main-row {
      display: grid;
      grid-template-columns: 1fr 300px;
      gap: 20px;
      margin-bottom: 24px;
      align-items: start;
    }

    @media (max-width: 860px) {
      .main-row {
        grid-template-columns: 1fr;
      }
    }

    /* ── Chart card ─────────────────────────────────────── */
    .chart-card {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 14px;
      padding: 24px;
    }

    .chart-card h2 {
      font-size: 16px;
      font-weight: 700;
      color: #1a1a2e;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 340px;
    }

    /* ── Summary card ───────────────────────────────────── */
    .summary-card {
      background: #fff;
      border: 1px solid #e2e6ea;
      border-radius: 14px;
      padding: 28px 24px;
    }

    .summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .summary-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #5b6abf;
    }

    .summary-dash {
      font-size: 18px;
      color: #c8ccd4;
    }

    .summary-value {
      font-size: 48px;
      font-weight: 800;
      color: #1a1a2e;
      line-height: 1.1;
      margin-bottom: 20px;
    }

    .summary-divider {
      border: none;
      border-top: 1px solid #e8ebf0;
      margin-bottom: 18px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
    }

    .summary-row-label {
      font-size: 14px;
      color: #8a8fa8;
    }

    .summary-row-value {
      font-size: 15px;
      font-weight: 600;
      color: #1a1a2e;
    }

    .trend-up { color: #e5484d !important; }
    .trend-down { color: #2da44e !important; }
    .trend-flat { color: #8a8fa8 !important; }

    /* ── Updated-at footer ──────────────────────────────── */
    .updated-at {
      text-align: center;
      font-size: 12px;
      color: #8a8fa8;
      padding: 12px 0 0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8a8fa8;
    }

    .empty-state p {
      margin-top: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 3h6v7l4 9H5l4-9V3z"/>
        <line x1="9" y1="3" x2="15" y2="3"/>
      </svg>
    </div>
    <div class="header-text">
      <h1>Skipped Tests Trend</h1>
      <p>wix-data-client repository</p>
    </div>
    <div class="header-right">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/>
      </svg>
      <select id="branch-select">
        <option value="">All branches</option>
      </select>
      <button class="btn-refresh" id="btn-refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
          <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
        </svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="container">
    <!-- Chart + Summary side by side -->
    <div class="main-row">
      <div class="chart-card">
        <h2>Skipped Tests Over Time</h2>
        <div class="chart-container">
          <canvas id="chart"></canvas>
        </div>
        <div class="empty-state" id="empty-state" style="display:none;">
          <p>No data yet. The GitHub Action will populate this automatically.</p>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-header">
          <span class="summary-label">Today's Skipped</span>
          <span class="summary-dash">—</span>
        </div>
        <div class="summary-value" id="today-skipped">—</div>
        <hr class="summary-divider">
        <div class="summary-row">
          <span class="summary-row-label">7-day average</span>
          <span class="summary-row-value" id="avg-7d">—</span>
        </div>
        <div class="summary-row">
          <span class="summary-row-label">Trend</span>
          <span class="summary-row-value" id="trend-label">—</span>
        </div>
      </div>
    </div>

    <div class="updated-at" id="updated-at"></div>
  </div>

  <script>
    let chartInstance = null;
    let allData = null;

    async function loadData() {
      const res = await fetch('data.json?t=' + Date.now());
      allData = await res.json();
      return allData;
    }

    function getBranches(data) {
      return [...new Set(data.entries.map(e => e.branch))].sort();
    }

    function filterEntries(data, branch) {
      let entries = data.entries;
      if (branch) entries = entries.filter(e => e.branch === branch);
      return entries.sort((a, b) => a.date.localeCompare(b.date));
    }

    function computeSummary(entries) {
      const today = new Date().toISOString().slice(0, 10);
      const todayEntry = entries.find(e => e.date === today);

      // Last 7 days
      const last7 = entries.slice(-7);
      const avg7 = last7.length > 0
        ? Math.round((last7.reduce((s, e) => s + e.skipped_count, 0) / last7.length) * 10) / 10
        : null;

      // Previous 7 days (for trend)
      const prev7 = entries.slice(-14, -7);
      const avgPrev = prev7.length >= 2
        ? prev7.reduce((s, e) => s + e.skipped_count, 0) / prev7.length
        : null;

      let trend = 'flat';
      if (avg7 !== null && avgPrev !== null) {
        const diff = avg7 - avgPrev;
        if (diff > 1) trend = 'up';
        else if (diff < -1) trend = 'down';
      }

      return {
        todaySkipped: todayEntry ? todayEntry.skipped_count : (entries.length > 0 ? entries[entries.length - 1].skipped_count : null),
        avg7,
        trend,
      };
    }

    function renderSummary(summary) {
      document.getElementById('today-skipped').textContent =
        summary.todaySkipped !== null ? summary.todaySkipped : '—';

      document.getElementById('avg-7d').textContent =
        summary.avg7 !== null ? summary.avg7 : '—';

      const trendEl = document.getElementById('trend-label');
      const labels = { up: 'Up', down: 'Down', flat: 'Flat' };
      trendEl.textContent = labels[summary.trend] || '—';
      trendEl.className = `summary-row-value trend-${summary.trend}`;
    }

    function renderChart(entries) {
      const canvas = document.getElementById('chart');
      const emptyState = document.getElementById('empty-state');

      if (!entries.length) {
        emptyState.style.display = 'block';
        canvas.style.display = 'none';
        if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
        return;
      }

      emptyState.style.display = 'none';
      canvas.style.display = 'block';

      const labels = entries.map(e => {
        const d = new Date(e.date + 'T00:00:00');
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      });
      const skipped = entries.map(e => e.skipped_count);

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(canvas, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Skipped Tests',
            data: skipped,
            borderColor: '#5b6abf',
            backgroundColor: 'rgba(91, 106, 191, 0.08)',
            fill: true,
            tension: 0.4,
            pointRadius: 4,
            pointBackgroundColor: '#5b6abf',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 7,
            borderWidth: 2.5,
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#fff',
              titleColor: '#1a1a2e',
              bodyColor: '#3a3f58',
              borderColor: '#e2e6ea',
              borderWidth: 1,
              padding: 10,
              cornerRadius: 8,
              displayColors: false,
              callbacks: {
                title: (items) => items[0].label,
                label: (item) => `Skipped: ${item.raw}`,
              },
            },
          },
          scales: {
            x: {
              ticks: { color: '#8a8fa8', font: { size: 12 } },
              grid: { display: false },
              border: { display: false },
            },
            y: {
              beginAtZero: true,
              ticks: { color: '#8a8fa8', font: { size: 12 }, stepSize: 15 },
              grid: { color: '#eef0f4', drawTicks: false },
              border: { display: false, dash: [4, 4] },
            },
          },
        },
      });
    }

    function renderUpdatedAt(data) {
      const el = document.getElementById('updated-at');
      if (data.updated_at) {
        const d = new Date(data.updated_at);
        el.textContent = `Last updated: ${d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} at ${d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}`;
      }
    }

    async function refresh() {
      const data = allData || await loadData();
      const branch = document.getElementById('branch-select').value;
      const entries = filterEntries(data, branch);
      const summary = computeSummary(entries);

      renderChart(entries);
      renderSummary(summary);
      renderUpdatedAt(data);
    }

    async function init() {
      const data = await loadData();

      // Populate branch dropdown
      const select = document.getElementById('branch-select');
      getBranches(data).forEach(b => {
        const opt = document.createElement('option');
        opt.value = b;
        opt.textContent = b;
        select.appendChild(opt);
      });

      select.addEventListener('change', refresh);
      document.getElementById('btn-refresh').addEventListener('click', async () => {
        allData = null;
        await loadData();
        refresh();
      });

      refresh();
    }

    init();
  </script>
</body>
</html>
